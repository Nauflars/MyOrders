# Supervisor Configuration for Symfony Messenger Workers
# 
# This configuration manages multiple worker processes for consuming
# async messages from RabbitMQ queues.
#
# Installation:
# 1. sudo apt-get install supervisor
# 2. sudo cp supervisor.conf /etc/supervisor/conf.d/myorders-worker.conf
# 3. sudo supervisorctl reread
# 4. sudo supervisorctl update
# 5. sudo supervisorctl start myorders-worker:*

[program:myorders-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/bin/console messenger:consume async --time-limit=3600 --memory-limit=512M -vv
autostart=true
autorestart=true
startretries=10
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/html/var/log/worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=30
stopasgroup=true
killasgroup=true
priority=999

# Restart workers every hour to prevent memory leaks
startsecs=10

[group:myorders-workers]
programs=myorders-worker
priority=999
